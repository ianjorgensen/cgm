<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Demo All Widgets</title>
<style>
  body { font: 12px system-ui, sans-serif; margin: 0; padding: 20px; }
  .wrap { max-width: 900px; margin: 0 auto; padding: 0 20px; }
  #viz { margin-bottom: 20px; }
  .row { display:flex; gap:20px; align-items:flex-start; margin-bottom: 20px; }
  .row > div { flex:1 1 0; min-width:0; }
  #agp, #strips { margin-top: 20px; }
  /* Fix strips width to 840px in demo */
  #strips { width: 840px; margin-top: 30px; }
  #tirdetailed {padding-left: 10px }
  #summary {padding-right: 50px }
  #controlBar {padding: 0 50px}
</style>

<div class="wrap">
  <div id="viz"></div>
  <div class="row" id="rowST">
    <div id="tirdetailed"></div>
    <div id="summary"></div>
    <!--
    <div id="tirbar"></div>
    <div id="tircard"></div>
    <div id="tiragpcard"></div>
    -->
  </div>
  <div id="agp"></div>
  <div id="strips"></div>
</div>

<link rel="stylesheet" href="../dist/lib/style.css" />
<script src="../dist/lib/cgm-tir.umd.js"></script>
<script>
  // Combined demo: TIR calendar + Summary synced to the selection
  fetch('../../cgm-data/cgm_data.json').then(r=>r.json()).then(data => {
    // Range presets JSON (for docs; widgets use internal mapping)
    const PRESETS = { N:'General', T:'Tight', P:'Pregnancy' }
    const DAY = 24*60*60*1000
    const t0 = new Date(data.t0).getTime()
    const tEnd = t0 + data.stepMs * (data.glucose.length - 1)
    const endDay = Date.UTC(new Date(tEnd).getUTCFullYear(), new Date(tEnd).getUTCMonth(), new Date(tEnd).getUTCDate()) + (DAY - 1)
    const startDay = Math.max(t0, endDay - 14*DAY + 1) // default: last 14 days

    const calendar = window.createTirCalendar('viz', data, { initialRange: { start: startDay, end: endDay }, preset: 'N', canvasVisible: false })
    // Summary stays in sync with calendar selection
    const summary = window.createCgmSummary('summary', data, { source: calendar, preset: 'N' })
    //const tirbar  = window.createCgmTir('tirbar', data, { source: calendar, preset: 'N' })
    //const makeClaude = window.createCgmTirClaude || (window.CgmTir && window.CgmTir.createCgmTirClaude)
    //const tirclaude = makeClaude ? makeClaude('tirclaude', data, { source: calendar, preset: 'N' }) : null
    //const tircard = window.createCgmTirCard('tircard', data, { source: calendar, preset: 'N' })
    //const tiragpcard = window.createCgmTirAgpCard('tiragpcard', data, { source: calendar, preset: 'N' })
    const tirdetailed = window.createCgmTirDetailed('tirdetailed', data, { source: calendar, preset: 'N' })
    const strips  = window.createCgmStrips('strips', data, { source: calendar, preset: 'N' })
    const agp     = window.createCgmAgp('agp', data, { source: calendar, preset: 'N' })

    window.addEventListener('keydown', (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : ''
      if (['input','textarea','select'].includes(tag)) return
      if (e.key.toLowerCase()==='t'){
        console.log('t')
        const cur = (window.__preset || 'N')
        const nxt = (cur==='T') ? 'N' : 'T'
        window.__preset = nxt
        calendar.setPreset(nxt); summary.setPreset(nxt); tirdetailed.setPreset(nxt); strips.setPreset(nxt); agp.setPreset(nxt)
        e.preventDefault()
      } else if (e.key.toLowerCase()==='p'){
        const cur = (window.__preset || 'N')
        const nxt = (cur==='P') ? 'N' : 'P'
        window.__preset = nxt
        calendar.setPreset(nxt); summary.setPreset(nxt); tirdetailed.setPreset(nxt); strips.setPreset(nxt); agp.setPreset(nxt)
        e.preventDefault()
      }
    })
  })
</script>
