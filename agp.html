<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>AGP Report — 14 Days</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --w: 1100px; }
  body { font: 13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:#222; margin: 16px; }
  h1,h2 { margin: 0 0 8px; }
  .card { border: 1px solid #e6e6e6; border-radius: 10px; padding: 16px; background: #fff; }
  .grid { display:grid; gap:16px; grid-template-columns: 1fr 330px; max-width: var(--w); }
  .stack { display:grid; gap:16px; max-width: var(--w); }
  .side { display:grid; gap:16px; }
  .metric { display:flex; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #eee; }
  .metric:last-child { border-bottom:none; }
  .muted { color:#777; font-size: 12px; }
  .pct { font-weight:600; }
  .goals { font-size:12px; color:#666; }
  .small { font-size:12px; color:#444; }
  .row { margin-top: 10px; }
  svg { width: 100%; height: auto; }
  .tinygrid { display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; }
  .tinylabel { text-align:center; font-size:11px; color:#444; margin-top:4px; }
</style>

<body>
  <h1><span style="color:#6a4cff;font-weight:700">AGP Report</span>: Continuous Glucose Monitoring</h1>

  <div class="grid">
    <!-- Left: Goals block (TIR) -->
    <div class="card" id="goalsCard">
      <h2>Goals for Type 1 and Type 2 Diabetes</h2>
      <svg id="goalsSvg" viewBox="0 0 640 220"></svg>
      <div class="goals" id="goalsNote" style="margin-top:6px;"></div>
    </div>

    <!-- Right: Metrics -->
    <div class="card side">
      <div class="metric"><div><b>Report Period</b></div><div id="period"></div></div>
      <div class="metric"><div><b>Time CGM Active</b></div><div id="active"></div></div>
      <div class="metric"><div><b>Average Glucose</b><div class="muted">Goal: &lt;154 mg/dL (8.6 mmol/L)</div></div><div id="avg"></div></div>
      <div class="metric"><div><b>Glucose Management Indicator (GMI)</b><div class="muted">Goal: &lt;7%</div></div><div id="gmi"></div></div>
      <div class="metric"><div><b>Glucose Variability (CV)</b><div class="muted">Goal: ≤36%</div></div><div id="cv"></div></div>
    </div>
  </div>

  <!-- AGP -->
  <div class="card row">
    <h2>Ambulatory Glucose Profile (AGP)</h2>
    <div class="muted">Median (50%) with interquartile (25–75%) and 5–95% bands aggregated over the report period.</div>
    <svg id="agp" viewBox="0 0 1100 420"></svg>
  </div>

  <!-- Daily small multiples -->
  <div class="card row">
    <h2>Daily Glucose Profiles</h2>
    <div class="tinygrid" id="smalls"></div>
  </div>

<script type="module">
import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
import { units, t0, stepMs, glucose } from "./cgm_data.js";

// ---- helpers ----
const isMmol = /mmol/i.test(units);
const toMg = v => isMmol ? v*18 : v;

// AGP thresholds (both units)
const TH = isMmol
  ? { vlow:3.0, low:3.9, high:10.0, vhigh:13.9, unit:"mmol/L" }
  : { vlow:54,  low:70,  high:180,  vhigh:250,  unit:"mg/dL" };

// Slice first 14 days
const tStart = new Date(t0).getTime();
const TWO_WKS = 14*24*60*60*1000;
const endT = tStart + TWO_WKS - stepMs; // inclusive last sample
const N = Math.min(glucose.length, Math.floor((endT - tStart)/stepMs)+1);
const time = Float64Array.from({length:N}, (_,i)=>tStart + i*stepMs);
const values = Float64Array.from(glucose.slice(0,N));

// Period text
const fmtDate = d3.timeFormat("%b %e, %Y");
document.getElementById("period").textContent =
  `${fmtDate(new Date(time[0]))} – ${fmtDate(new Date(time[time.length-1]))}`;

// Time Active (% of expected samples in 14 days at given cadence)
const expected = Math.round(TWO_WKS / stepMs);
const present = values.filter(v => Number.isFinite(v)).length;
const activePct = 100 * present / expected;
document.getElementById("active").textContent = `${activePct.toFixed(1)}%`;

// Average, GMI, CV
const meanVal = d3.mean(values);
const sdVal = Math.sqrt(d3.variance(values) ?? 0);
const GMI = 3.31 + 0.02392 * toMg(meanVal);  // Clarke 2019
const CV = (sdVal / meanVal) * 100;

document.getElementById("avg").textContent =
  isMmol ? `${meanVal.toFixed(1)} mmol/L` : `${meanVal.toFixed(0)} mg/dL`;
document.getElementById("gmi").textContent = `${GMI.toFixed(1)}%`;
document.getElementById("cv").textContent  = `${CV.toFixed(1)}%`;

// TIR counts
let cVL=0,cL=0,cT=0,cH=0,cVH=0;
for (const v of values){
  if (v < TH.vlow) cVL++;
  else if (v < TH.low) cL++;
  else if (v <= TH.high) cT++;
  else if (v <= TH.vhigh) cH++;
  else cVH++;
}
const pct = c => (100*c/values.length);
const P = { VL:pct(cVL), L:pct(cL), T:pct(cT), H:pct(cH), VH:pct(cVH) };

// ---- Goals block (stacked vertical bar + labels) ----
(function renderGoals(){
  const svg = d3.select("#goalsSvg");
  svg.selectAll("*").remove();
  const W = 640, H = 220;
  const barX = 70, barW = 80, barTop = 20, barH = 180;

  const scaleY = d3.scaleLinear().domain([0,100]).range([barTop+barH, barTop]);

  const bands = [
    {name:"Very High", pct:P.VH, color:"#f46d43", goal:"<5%"},
    {name:"High",      pct:P.H,  color:"#fdae61", goal:"<25%"},
    {name:"Target",    pct:P.T,  color:"#1a9850", goal:"≥70%"},
    {name:"Low",       pct:P.L,  color:"#e34a33", goal:"<4%"},
    {name:"Very Low",  pct:P.VL, color:"#b30000", goal:"<1%"},
  ];

  // thresholds ruler on the left
  const ruleVals = [TH.vhigh, TH.high, TH.low, TH.vlow];
  svg.append("g").selectAll("text").data(ruleVals).join("text")
    .attr("x", barX - 20).attr("y", (_,i)=> barTop + (i*barH/4) + 4)
    .attr("text-anchor","end").attr("font-size",11).text(d=>d);

  let acc = 0;
  bands.forEach(b=>{
    const y1 = scaleY(acc + b.pct), y0 = scaleY(acc);
    svg.append("rect").attr("x", barX).attr("y", y1)
      .attr("width", barW).attr("height", y0 - y1)
      .attr("fill", b.color);

    // label on right
    svg.append("text").attr("x", barX + barW + 20).attr("y", (y0+y1)/2 + 4)
      .attr("class","pct").text(`${b.name} ${b.pct.toFixed(0)}%`);
    svg.append("text").attr("x", barX + barW + 110).attr("y", (y0+y1)/2 + 4)
      .attr("fill","#666").attr("font-size",11).text(`Goal: ${b.goal}`);
    acc += b.pct;
  });

  svg.append("text").attr("x",10).attr("y",16).attr("font-weight",600)
    .text(`Goals for ${isMmol ? "mmol/L" : "mg/dL"}`);
  document.getElementById("goalsNote").textContent =
    `Each 1% time in range ≈ ${(stepMs/60000*values.length/100).toFixed(0)} minutes over the 14-day period.`;
})();

// ---- AGP computation: percentiles per 5-min-of-day ----
const samplesPerDay = Math.round(24*60*60*1000/stepMs);
const days = Math.floor(values.length / samplesPerDay);

const byMin = Array.from({length: samplesPerDay}, ()=>[]);
for (let d=0; d<days; d++){
  for (let i=0;i<samplesPerDay;i++){
    const v = values[d*samplesPerDay + i];
    if (Number.isFinite(v)) byMin[i].push(v);
  }
}
const q = (arr,p) => {
  if (arr.length===0) return NaN;
  const a = Float64Array.from(arr).sort();
  const pos = (a.length-1)*p, b = Math.floor(pos), r = pos-b;
  return a[b] + (a[Math.min(a.length-1,b+1)]-a[b])*(r||0);
};
const seriesAGP = byMin.map((arr,i)=>({
  t: i,
  p05: q(arr,0.05), p25: q(arr,0.25),
  p50: q(arr,0.50), p75: q(arr,0.75),
  p95: q(arr,0.95)
}));

// ---- Render AGP chart ----
(function renderAGP(){
  const svg = d3.select("#agp"); svg.selectAll("*").remove();
  const W = 1100, H = 420, M = {l:60,r:70,t:30,b:40};
  const x = d3.scaleLinear().domain([0, samplesPerDay]).range([M.l, W-M.r]);
  const y = d3.scaleLinear().domain(d3.extent(seriesAGP.flatMap(s=>[s.p05,s.p95])))
              .nice().range([H-M.b, M.t]);

  // target band
  svg.append("rect").attr("x",M.l).attr("width",W-M.l-M.r)
    .attr("y", y(TH.high)).attr("height", y(TH.low)-y(TH.high))
    .attr("fill","#E8F6EC");

  const area25_75 = d3.area().x(d=>x(d.t)).y0(d=>y(d.p25)).y1(d=>y(d.p75));
  const area05_95 = d3.area().x(d=>x(d.t)).y0(d=>y(d.p05)).y1(d=>y(d.p95));
  const line50 = d3.line().x(d=>x(d.t)).y(d=>y(d.p50));

  svg.append("path").attr("d", area05_95(seriesAGP)).attr("fill","#f4c7a4").attr("opacity",0.55);
  svg.append("path").attr("d", area25_75(seriesAGP)).attr("fill","#fbd699").attr("opacity",0.8);
  svg.append("path").attr("d", line50(seriesAGP)).attr("stroke","#1a9850").attr("fill","none").attr("stroke-width",2);

  // target lines
  svg.append("line").attr("x1",M.l).attr("x2",W-M.r).attr("y1",y(TH.high)).attr("y2",y(TH.high))
    .attr("stroke","#1a9850").attr("stroke-width",2);
  svg.append("line").attr("x1",M.l).attr("x2",W-M.r).attr("y1",y(TH.low)).attr("y2",y(TH.low))
    .attr("stroke","#1a9850").attr("stroke-width",2);

  // x axis: time-of-day every 3h
  const ticks = d3.range(0, 24+1, 3).map(h=>h*60*60*1000/stepMs);
  const fmtHr = h => (h===0||h===24) ? "12am" : (h<12?`${h}am`:(h===12?"12pm":`${h-12}pm`));
  svg.append("g").attr("transform",`translate(0,${H-M.b})`)
    .call(d3.axisBottom(x).tickValues(ticks).tickFormat(t=>fmtHr(Math.round(t/(60*60*1000/stepMs)))));
  svg.append("g").attr("transform",`translate(${M.l},0)`).call(d3.axisLeft(y));
  svg.append("text").attr("x",M.l).attr("y",20).text(`AGP — ${units}`);
})();

// ---- Daily small multiples (14 panels) ----
(function renderSmalls(){
  const container = d3.select("#smalls"); container.selectAll("*").remove();
  const dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  const samplesPerDay = Math.round(24*60*60*1000/stepMs);
  const w = 150, h = 70, m = {l:26,r:6,t:12,b:16};

  for (let d=0; d<14; d++){
    const svg = container.append("div").html(`<svg viewBox="0 0 ${w} ${h}"></svg><div class="tinylabel"></div>`)
      .select("svg");
    const startIdx = d*samplesPerDay;
    const arr = [];
    for (let i=0;i<samplesPerDay && startIdx+i<values.length;i++){
      arr.push({i, v: values[startIdx+i]});
    }
    const x = d3.scaleLinear().domain([0, samplesPerDay-1]).range([m.l, w-m.r]);
    const y = d3.scaleLinear().domain(d3.extent(arr, d=>d.v)).nice().range([h-m.b, m.t]);

    // target band
    svg.append("rect").attr("x",m.l).attr("width",w-m.l-m.r)
      .attr("y", y(TH.high)).attr("height", y(TH.low)-y(TH.high))
      .attr("fill","#E8F6EC");

    svg.append("path")
      .attr("d", d3.line().x(d=>x(d.i)).y(d=>y(d.v))(arr))
      .attr("fill","none").attr("stroke","#E08A00").attr("stroke-width",1.2);

    svg.append("line").attr("x1",m.l).attr("x2",w-m.r).attr("y1",y(TH.low)).attr("y2",y(TH.low))
      .attr("stroke","#1a9850");
    svg.append("line").attr("x1",m.l).attr("x2",w-m.r).attr("y1",y(TH.high)).attr("y2",y(TH.high))
      .attr("stroke","#1a9850");

    // noon tick
    const noon = Math.round(12*60*60*1000/stepMs);
    svg.append("line").attr("x1",x(noon)).attr("x2",x(noon)).attr("y1",h-m.b).attr("y2",h-m.b+4)
      .attr("stroke","#000");
    const label = d3.select(svg.node().parentNode).select(".tinylabel");
    const d0 = new Date(time[0] + d*24*60*60*1000);
    label.text(`${dayNames[d0.getDay()]} — ${d3.timeFormat("%b %e")(d0)}`);
  }
})();
</script>
</body>
</html>
