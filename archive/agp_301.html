<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>AGP — Last 30 Days</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font: 13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; color:#222; }
  h1 { margin: 0 0 8px; font-weight: 700; }
  #agp { width: 1100px; max-width: 96vw; height: 440px; border: 1px solid #eee; background: #fff; }
  .note { color:#666; font-size:12px; margin:6px 0 14px; }
</style>

<body>
  <h1>Ambulatory Glucose Profile — Last 30 Days</h1>
  <div class="note">AGP summarizes glucose values from the last 30 days, showing the median (50%) and other percentiles as if they occurred in a single day. Bands change color where they cross target thresholds.</div>
  <svg id="agp" viewBox="0 0 1100 440"></svg>
  <h2 style="margin-top:18px;">Daily Glucose Profiles</h2>
  <div class="note">Each panel shows one day (midnight–midnight) from the last 30 days. Yellow/orange regions are above target; red is below target; green band indicates target range.</div>
  <div id="dailyGrid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; max-width:1100px;"></div>

<script type="module">
import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
import { units, t0, stepMs, glucose } from "./cgm_data_test.js";

const svg = d3.select('#agp');
const W = 1100, H = 440, M = {l:70,r:80,t:20,b:40};

const isMmol = /mmol/i.test(units);
const TH = isMmol ? { low:3.9, high:10.0 } : { low:70, high:180 };

const tStart = new Date(t0).getTime();
const time = Float64Array.from({length:glucose.length}, (_,i)=> tStart + i*stepMs);
const values = Float64Array.from(glucose);

// last 30 days
const dayMs = 24*60*60*1000;
const samplesPerDay = Math.round(dayMs/stepMs);
const lastN = Math.min(values.length, 30*samplesPerDay);
const startIdx = Math.max(0, values.length - lastN);

const byMin = Array.from({length: samplesPerDay}, ()=>[]);
for (let i=startIdx;i<values.length;i++){
  const v = values[i]; if (!Number.isFinite(v) || v<0) continue;
  const t = time[i]; const d = new Date(t);
  const midnight = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
  let bin = Math.round((t - midnight) / stepMs);
  if (bin < 0) bin = 0; else if (bin >= samplesPerDay) bin = samplesPerDay-1;
  byMin[bin].push(v);
}

const q = (arr,p)=>{ if(!arr.length) return NaN; const a=Float64Array.from(arr).sort(); const pos=(a.length-1)*p, b=Math.floor(pos), r=pos-b; return a[b] + (a[Math.min(a.length-1,b+1)]-a[b])*(r||0); };
const series = byMin.map((arr,i)=>({ t:i, p05:q(arr,0.05), p25:q(arr,0.25), p50:q(arr,0.50), p75:q(arr,0.75), p95:q(arr,0.95) }));

const yDomain = isMmol ? [0,20] : [0,350];
const x = d3.scaleLinear().domain([0, samplesPerDay-1]).range([M.l, W-M.r]);
const y = d3.scaleLinear().domain(yDomain).nice().range([H-M.b, M.t]);

// target band
svg.append('rect').attr('x',M.l).attr('width',W-M.l-M.r).attr('y',y(TH.high)).attr('height',y(TH.low)-y(TH.high)).attr('fill','#E8F6EC');

const clampLow  = v => Math.min(v, TH.low);
const clampHigh = v => Math.max(v, TH.high);
const clampIn   = v => Math.max(TH.low, Math.min(TH.high, v));

// 5–95% band
const area05_95 = d3.area().defined(d=>Number.isFinite(d.p05)&&Number.isFinite(d.p95)).x(d=>x(d.t)).y0(d=>y(d.p05)).y1(d=>y(d.p95));
svg.append('path').attr('d', area05_95(series)).attr('fill','#f6d2b7').attr('opacity',0.8);
// red below low
const area05_low = d3.area().defined(d=>Number.isFinite(d.p05)&&Number.isFinite(d.p25)&&d.p25<TH.low).x(d=>x(d.t)).y0(d=>y(d.p05)).y1(d=>y(clampLow(d.p25)));
svg.append('path').attr('d', area05_low(series)).attr('fill','#d34a4a').attr('opacity',0.7);
// orange above high
const area95_high = d3.area().defined(d=>Number.isFinite(d.p95)&&Number.isFinite(d.p75)&&d.p75>TH.high).x(d=>x(d.t)).y0(d=>y(clampHigh(d.p75))).y1(d=>y(d.p95));
svg.append('path').attr('d', area95_high(series)).attr('fill','#f2b26a').attr('opacity',0.8);

// IQR segments
const areaIQR_in = d3.area().defined(d=>Number.isFinite(d.p25)&&Number.isFinite(d.p75)&&d.p75>TH.low&&d.p25<TH.high).x(d=>x(d.t)).y0(d=>y(clampIn(d.p25))).y1(d=>y(clampIn(d.p75)));
svg.append('path').attr('d', areaIQR_in(series)).attr('fill','#82c79a').attr('opacity',0.85);
const areaIQR_low = d3.area().defined(d=>Number.isFinite(d.p25)&&Number.isFinite(d.p75)&&d.p25<TH.low).x(d=>x(d.t)).y0(d=>y(d.p25)).y1(d=>y(clampLow(d.p75)));
svg.append('path').attr('d', areaIQR_low(series)).attr('fill','#c74242').attr('opacity',0.8);
const areaIQR_high = d3.area().defined(d=>Number.isFinite(d.p25)&&Number.isFinite(d.p75)&&d.p75>TH.high).x(d=>x(d.t)).y0(d=>y(clampHigh(d.p25))).y1(d=>y(d.p75));
svg.append('path').attr('d', areaIQR_high(series)).attr('fill','#e9a24e').attr('opacity',0.9);

// Median line by zone
const lineMed = (pred, color)=>{ const l=d3.line().defined(d=>Number.isFinite(d.p50)&&pred(d.p50)).x(d=>x(d.t)).y(d=>y(d.p50)); svg.append('path').attr('d', l(series)).attr('stroke',color).attr('fill','none').attr('stroke-width',3); };
lineMed(v=>v<TH.low,'#c74242'); lineMed(v=>v>=TH.low&&v<=TH.high,'#1a9850'); lineMed(v=>v>TH.high,'#e08a00');

// Target lines
svg.append('line').attr('x1',M.l).attr('x2',W-M.r).attr('y1',y(TH.high)).attr('y2',y(TH.high)).attr('stroke','#1a9850').attr('stroke-width',3);
svg.append('line').attr('x1',M.l).attr('x2',W-M.r).attr('y1',y(TH.low)).attr('y2',y(TH.low)).attr('stroke','#1a9850').attr('stroke-width',3);

// Axes
const xHour = d3.scaleLinear().domain([0,24]).range([M.l, W-M.r]);
svg.append('g').attr('transform',`translate(0,${H-M.b})`).call(d3.axisBottom(xHour).ticks(8).tickFormat(h=>{ if(h===0||h===24) return '12am'; if(h===12) return '12pm'; return h<12? `${h}am`:`${h-12}pm`; }));
svg.append('g').attr('transform',`translate(${M.l},0)`).call(d3.axisLeft(y).ticks(6));

// Extra threshold lines/labels for 250 mg/dL (13.9 mmol/L) and 54 mg/dL (3.0 mmol/L)
const VH = isMmol ? 13.9 : 250;
const VL = isMmol ? 3.0  : 54;
const fmtVal = v => isMmol ? v.toFixed(1) : Math.round(v).toString();
svg.append('line').attr('x1',M.l).attr('x2',W-M.r).attr('y1',y(VH)).attr('y2',y(VH)).attr('stroke','#d9d9d9').attr('stroke-width',2);
svg.append('line').attr('x1',M.l).attr('x2',W-M.r).attr('y1',y(VL)).attr('y2',y(VL)).attr('stroke','#d9d9d9').attr('stroke-width',2);
svg.append('text').attr('x', M.l - 24).attr('y', y(VH)).attr('dy','0.35em').attr('fill','#777').attr('font-weight',700).text(fmtVal(VH));
svg.append('text').attr('x', M.l - 24).attr('y', y(VL)).attr('dy','0.35em').attr('fill','#777').attr('font-weight',700).text(fmtVal(VL));

// Decorative y-axis target labels (units-aware)
// Badge helper
function badge(x0, y0, txt){
  const g = svg.append('g');
  const padX = 8, padY = 5;
  const t = g.append('text').attr('x', x0 + padX).attr('y', y0).attr('dy','0.35em')
    .attr('fill','#fff').attr('font-weight',700).text(txt);
  const bb = t.node().getBBox();
  g.insert('rect', 'text').attr('x', bb.x - 6).attr('y', bb.y - 4).attr('width', bb.width + 12).attr('height', bb.height + 8)
    .attr('rx',4).attr('ry',4).attr('fill','#1a9850');
}

// Unit label near the top tick
svg.append('text').attr('x', M.l - 46).attr('y', M.t + 10)
  .attr('fill','#777').attr('font-weight',700).text(isMmol ? `${yDomain[1]}` : `${yDomain[1]}`);
svg.append('text').attr('x', M.l - 46).attr('y', M.t + 26)
  .attr('fill','#777').attr('font-size',12).text(isMmol ? 'mmol/L' : 'mg/dL');

// Badges for target high/low
badge(M.l - 56, y(TH.high), isMmol ? `${TH.high}` : `${TH.high}`);
badge(M.l - 56, y(TH.low),  isMmol ? `${TH.low}`  : `${TH.low}`);

// Label "Target Range" stacked between high/low
const midTR = (y(TH.low) + y(TH.high))/2;
svg.append('text').attr('x', M.l - 70).attr('y', midTR - 10)
  .attr('font-weight',800).attr('font-size',18).attr('text-anchor','end').text('Target');
svg.append('text').attr('x', M.l - 70).attr('y', midTR + 10)
  .attr('font-weight',800).attr('font-size',18).attr('text-anchor','end').text('Range');


</script>
<script type="module">
// Small multiples calendar: last 30 days
import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
import { units, t0, stepMs, glucose } from "./cgm_data_test.js";

const container = d3.select('#dailyGrid');
const dayMs = 24*60*60*1000;
const samplesPerDay = Math.round(dayMs/stepMs);
const tStart = new Date(t0).getTime();
const time = Float64Array.from({length:glucose.length}, (_,i)=> tStart + i*stepMs);
const values = Float64Array.from(glucose);
const isMmol = /mmol/i.test(units);
const TH = isMmol ? { low:3.9, high:10.0 } : { low:70, high:180 };
const yDomain = isMmol ? [0,20] : [0,350];

// slice last 30 days
const totalDays = Math.min(30, Math.floor(values.length / samplesPerDay));
const startIdx = Math.max(0, values.length - totalDays*samplesPerDay);

// gather day arrays
const days = [];
for (let d=0; d<totalDays; d++){
  const s = startIdx + d*samplesPerDay;
  const e = Math.min(values.length, s + samplesPerDay);
  const arr = [];
  for (let i=s;i<e;i++) arr.push({i:i-s, t: new Date(time[i]), v: values[i]});
  days.push(arr);
}

const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const w=150, h=70, m={l:22,r:6,t:14,b:16};

days.forEach((arr, idx)=>{
  const svg = container.append('div').append('svg').attr('viewBox',`0 0 ${w} ${h}`);
  const x = d3.scaleLinear().domain([0, samplesPerDay-1]).range([m.l, w-m.r]);
  const y = d3.scaleLinear().domain(yDomain).range([h-m.b, m.t]);
  // target band
  svg.append('rect').attr('x',m.l).attr('width',w-m.l-m.r).attr('y', y(TH.high)).attr('height', y(TH.low)-y(TH.high)).attr('fill','#E8F6EC');
  // above target (orange)
  const areaHigh = d3.area().defined(d=>Number.isFinite(d.v) && d.v>TH.high).x(d=>x(d.i)).y0(()=>y(TH.high)).y1(d=>y(d.v));
  svg.append('path').attr('d', areaHigh(arr)).attr('fill','#f2b26a').attr('opacity',0.8);
  // below target (red)
  const areaLow = d3.area().defined(d=>Number.isFinite(d.v) && d.v<TH.low && d.v>=0).x(d=>x(d.i)).y0(d=>y(d.v)).y1(()=>y(TH.low));
  svg.append('path').attr('d', areaLow(arr)).attr('fill','#d34a4a').attr('opacity',0.8);
  // line
  svg.append('path').attr('d', d3.line().defined(d=>Number.isFinite(d.v) && d.v>=0).x(d=>x(d.i)).y(d=>y(d.v))(arr)).attr('fill','none').attr('stroke','#555');
  // day name + date
  const d0 = arr.length? arr[0].t : new Date();
  const label = `${dayNames[d0.getDay()].slice(0,3)} ${String(d0.getMonth()+1).padStart(2,'0')}/${String(d0.getDate()).padStart(2,'0')}`;
  svg.append('text').attr('x', m.l).attr('y', 12).attr('fill','#333').attr('font-size',11).text(label);
  // noon tick
  const noon = Math.round(12*60*60*1000/stepMs);
  svg.append('line').attr('x1',x(noon)).attr('x2',x(noon)).attr('y1',h-m.b).attr('y2',h-m.b+3).attr('stroke','#000');
});
</script>
</script>
</body>
</html>
